#!/bin/bash
# Запрашиваем пароль sudo один раз в начале
echo "Введите пароль sudo для продолжения:"
sudo -v

# Проверяем, удалось ли получить привилегии sudo
if [ $? -ne 0 ]; then
    echo "Ошибка: Не удалось получить привилегии sudo. Выход."
    exit 1
fi
 echo "Процедура подкотовки к работе"
 echo "_____________________________"



# Список портов для освобождения
PORTS=(8080 8000 9000)

for PORT in "${PORTS[@]}"; do
    echo "---"
    echo "Обрабатываю порт: $PORT"
    # Находим PID процесса, использующего порт
    PID=$(lsof -t -i :$PORT)

    if [ -z "$PID" ]; then
        echo "Порт $PORT свободен."
    else
        echo "Порт $PORT занят процессом с PID: $PID. Пытаюсь завершить..."
        kill -9 $PID
        if [ $? -eq 0 ]; then
            echo "Процесс с PID $PID успешно завершен. Порт $PORT теперь свободен."
        else
            echo "Не удалось завершить процесс с PID $PID. Возможно, требуются права суперпользователя."
        fi
    fi
done
echo "---"
echo "Завершил проверку всех портов."

# Инициализация Conda, если она еще не инициализирована в вашей оболочке.
# Обычно это уже сделано в вашем ~/.bashrc или ~/.zshrc.
# Если вы видите ошибку "conda: command not found", раскомментируйте следующую строку
# и убедитесь, что путь к вашему bash_conda_init.sh правильный.
# source ~/miniconda3/etc/profile.d/conda.sh # Или путь к вашей установке Conda

# Активируем Conda окружение
conda activate rag_env

# Проверяем, что активация прошла успешно
if [ $? -ne 0 ]; then
    echo "Ошибка активации Conda окружения 'rag_env'. Проверьте его наличие."
    exit 1
fi

# Переходим в нужную директорию
cd ~/secure_rag/scripts/

# Проверяем, что переход в директорию прошел успешно
if [ $? -ne 0 ]; then
    echo "Ошибка: Не удалось перейти в директорию ~/secure_rag/scripts/."
    exit 1
fi

# Теперь запускаем ваш второй скрипт run2.sh
# Он будет выполняться в активированном окружении и в новой директории
echo "Запускаю 07.start_Web_rag_app.py в активированном окружении и в директории ~/secure_rag/scripts/..."

# python ./07.start_Web_rag_app.py

echo "Основной скрипт завершен."



